# webhooks: Вебхуки


Вебхуки позволяют моментально получать информацию об изменении объекта в Poster.
Например, когда добавили новый товар в меню или пробили чек.


## Подключение

1. Перейдите в свой [аккаунт разработчика](/login) → Настройки приложения
2. В блоке **Вебхуки** и выбирете сущности по которым хотите получать хуки и URL на который отсылать хуки
3. Подключите ваше приложение в аккаунте по которому нужно получать хуки
4. Отредактируйте, удалите или создайте сущность чтобы выполнить отправку хука

Например, для отправки хука по заказам нужно подписаться на сущность `transaction` и закрыть заказ на терминале.


### Параметры вебхука

> Пример входящего вебхука:
 
```json
{
  "account":"api-demo",
  "account_number":"813932",
  "object":"transaction",
  "object_id":1,
  "action":"added",
  "time":"1518794257",
  "verify":"a23sk3d9123ka31sd3k5asd9123sad93"
}
```

> Пример обработки вебхука:

```php
<?php
// Секретный ключ вашего приложения
$client_secret = 'fe2bc8e865d8fc2236968ee53c3b2bd5';

// Приводим к нужному формату входящие данные
$postJSON = file_get_contents('php://input');
$postData = json_decode($postJSON, true);

$verify_original = $postData['verify'];
unset($postData['verify']);

$verify = [
    $postData['account'],
    $postData['object'],
    $postData['object_id'],
    $postData['action'],
];

// Если есть дополнительные параметры
if (isset($postData['data'])) {
    $verify[] = $postData['data'];
}
$verify[] = $postData['time'];
$verify[] = $client_secret;

// Создаём строку для верификации запроса клиентом
$verify = md5(implode(';', $verify));

// Проверяем валидность данных 
if ($verify != $verify_original) {
    exit;
}

// Если не ответить на запрос, Poster продолжит слать Webhook
echo json_encode(['status' => 'accept']);
 ```




Все уведомления приходят `POST` запросом и содержат следующие параметры: 

Параметр | Описание
-------- | --------
account | Аккаунт клиента, который создал событие
account_number | Номер аккаунта, который создал событие
object | Сущность по которой поступил вебхук
object_id | Первичный ключ объекта
action | Действие выполненное над сущностью: `added` — добавлен, `changed` — измененен, `removed` — удален, `transformed` — трансформация (например, тех. карты в товар и наоборот)
time | Время отправки вебхука в Unix timestamp 
verify | Подпись запроса, состоит из md5 от `account`, `object`, `object_id`, `action`, `data` (если передается), `time` и `secret` соединенных через `;`    
data | Дополнительный параметр у некоторых сущностей

<aside class="info">
    На полученный вебхук нужно отвечать 200 статусом по HTTP протоколу. 
    Иначе мы будем считать вебхук не доставленным и попытаемся отправить его еще 15 раз в течение двух дней.
</aside>


## Заказы

Сущность | Описание
-------- | --------
transaction | Заказы
incoming_order | Онлайн-заказы и бронирование

### incoming_order: Состояние онлайн-заказа

Событие `changed` срабатывает при изменении статуса заказа с **новый** на **применен** или **отклонен**.


## Меню

Сущность | Описание
-------- | --------
product | Товары
dish | Тех. карты
category | Категории товаров и тех. карт
prepack | Полуфабрикаты
ingredient | Ингредиенты
workshop | Цеха
ingredients_category | Категории ингридиентов


## Маркетинг

Сущность | Описание
-------- | --------
client | Клиенты
client_payed_sum | Закрытие заказа с привязаным клиентом
clients_group | Группы клиентов
promotion | Акции
promotion_prize | Накоплени акции
client_ewallet | Депозиты клиента
loyalty rule | Правила перехода между группами клиентов

### client_ewallet

В теле хука приходит дополнительный параметр `data` который содержит следующие параметры:

Параметр | Описание
-------- | --------
value_relative | Дельта изменения суммы на депозитном счету
value_absolute | Итоговая сумма на депозитном счету


## Склад 

Сущность | Описание
-------- | --------
storage | Склады
stock | Состояние товара или ингрединта на складе
supply | Поставки

### stock

В теле хука приходит дополнительный параметр `data` который содержит следующие параметры:

Параметр | Описание
-------- | --------
type | Тип, принимает значение: 1 — полноценный ингредиент, 2 — товар, 3 — модификатор, 4 — производимая тех. карта, 5 — производимый полуфабрикат 
element_id | Первичный ключ объекта
storage_id | Первичный ключ объекта склада
value_relative | Изменение количества позиции на складе
value_absolute | Конечное значение количества позиции на складе


## Финансы

Сущность | Описание
-------- | --------
book_transaction | Финансовые транзакции
cash_shift_transaction | Кассовые транзакции


## Доступ

Сущность | Описание
-------- | --------
spot | Заведения
register | Касса
waiter | Официант


## Настройки и приложения

Сущность | Описание
-------- | --------
configs | Настройки 
application | Установка или удаление приложения

### application
 
В теле хука приходит дополнительный параметр `data` который содержит следующие параметры:

Параметр | Описание
-------- | --------
user_id | Id сотрудника, который установил приложение
access_token | Токен доступа для работы с API. Возврашается в случае, если `action` — `added`.
